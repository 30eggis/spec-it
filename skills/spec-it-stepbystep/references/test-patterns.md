# Test Patterns Guide

Pattern guide for test specifications generated by spec-it.

## Test Types

### 1. Unit Tests

Testing independent behavior of individual components/functions

```typescript
// Component Unit Test
describe('Button', () => {
  it('renders with default props', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByRole('button')).toHaveTextContent('Click me');
  });

  it('calls onClick when clicked', async () => {
    const handleClick = vi.fn();
    render(<Button onClick={handleClick}>Click</Button>);
    await userEvent.click(screen.getByRole('button'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('is disabled when disabled prop is true', () => {
    render(<Button disabled>Disabled</Button>);
    expect(screen.getByRole('button')).toBeDisabled();
  });
});
```

### 2. Integration Tests

Testing scenarios where multiple components work together

```typescript
// Form Integration Test
describe('LoginForm', () => {
  it('submits form with valid data', async () => {
    const handleSubmit = vi.fn();
    render(<LoginForm onSubmit={handleSubmit} />);

    await userEvent.type(screen.getByLabelText('Email'), 'test@example.com');
    await userEvent.type(screen.getByLabelText('Password'), 'password123');
    await userEvent.click(screen.getByRole('button', { name: 'Login' }));

    expect(handleSubmit).toHaveBeenCalledWith({
      email: 'test@example.com',
      password: 'password123',
    });
  });

  it('shows validation errors', async () => {
    render(<LoginForm onSubmit={vi.fn()} />);

    await userEvent.click(screen.getByRole('button', { name: 'Login' }));

    expect(screen.getByText('Email is required')).toBeInTheDocument();
    expect(screen.getByText('Password is required')).toBeInTheDocument();
  });
});
```

### 3. E2E Tests (Playwright)

Testing complete user flows

```typescript
// E2E Test
test('user can login and access dashboard', async ({ page }) => {
  // Given
  await page.goto('/login');

  // When
  await page.fill('[data-testid="email"]', 'user@example.com');
  await page.fill('[data-testid="password"]', 'password123');
  await page.click('[data-testid="login-button"]');

  // Then
  await expect(page).toHaveURL('/dashboard');
  await expect(page.locator('[data-testid="welcome-message"]')).toContainText('Welcome');
});
```

## Test Patterns

### AAA Pattern (Arrange-Act-Assert)

```typescript
it('should do something', () => {
  // Arrange - Setup
  const input = 'test input';
  const expected = 'expected output';

  // Act - Execute
  const result = functionUnderTest(input);

  // Assert - Verify
  expect(result).toBe(expected);
});
```

### Given-When-Then Pattern

```typescript
it('should update state when button clicked', () => {
  // Given - Precondition
  const { getByRole } = render(<Counter initialCount={0} />);

  // When - Action
  fireEvent.click(getByRole('button', { name: 'Increment' }));

  // Then - Expected result
  expect(getByRole('heading')).toHaveTextContent('Count: 1');
});
```

## Component Test Checklist

### Rendering
- [ ] Renders with default props
- [ ] Error on missing required props
- [ ] Optional props behavior
- [ ] Children rendering

### States
- [ ] default state
- [ ] hover state
- [ ] focus state
- [ ] disabled state
- [ ] loading state
- [ ] error state

### Interactions
- [ ] Click events
- [ ] Keyboard events
- [ ] Form submission
- [ ] Input changes

### Accessibility
- [ ] aria attributes
- [ ] Keyboard navigation
- [ ] Screen reader compatibility
- [ ] Focus management

## Mocking Patterns

### API Mock

```typescript
// MSW (Mock Service Worker)
import { rest } from 'msw';
import { setupServer } from 'msw/node';

const server = setupServer(
  rest.get('/api/user', (req, res, ctx) => {
    return res(ctx.json({ name: 'John' }));
  })
);

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());
```

### Module Mock

```typescript
// vi.mock
vi.mock('@/lib/api', () => ({
  fetchUser: vi.fn().mockResolvedValue({ name: 'John' }),
}));
```

### Timer Mock

```typescript
beforeEach(() => {
  vi.useFakeTimers();
});

afterEach(() => {
  vi.useRealTimers();
});

it('debounces input', async () => {
  render(<SearchInput />);
  await userEvent.type(screen.getByRole('textbox'), 'test');
  vi.advanceTimersByTime(300);
  // assertions
});
```

## Persona-Based Testing

```typescript
// Persona: Busy Professional
describe('Busy Professional Scenario', () => {
  const persona = {
    device: 'mobile',
    connection: 'slow-3g',
    timeConstraint: 'limited',
  };

  it('accesses core info within 3 seconds', async ({ page }) => {
    await page.emulateNetworkConditions(slow3G);
    const start = Date.now();

    await page.goto('/dashboard');
    await page.waitForSelector('[data-testid="key-metric"]');

    expect(Date.now() - start).toBeLessThan(3000);
  });

  it('performs main functions with one hand', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 });

    // All main buttons should be in bottom 1/3 of screen
    const buttons = await page.locator('[data-testid="action-button"]').all();
    for (const button of buttons) {
      const box = await button.boundingBox();
      expect(box.y).toBeGreaterThan(667 * 0.66);
    }
  });
});
```

## Coverage Goals

| Type | Minimum | Recommended |
|------|---------|-------------|
| Unit | 70% | 90% |
| Integration | 50% | 70% |
| E2E | 30% | 50% |
| A11y | 100% | 100% |

## Test Naming Convention

```
[Target] [Condition] [Expected Result]

Examples:
- Button renders correctly with default props
- Form shows validation error when email is invalid
- User can navigate to dashboard after login
```

## Reference Tools

- **Vitest**: Test runner
- **React Testing Library**: Component testing
- **Playwright**: E2E testing
- **MSW**: API mocking
- **axe-core**: Accessibility testing
